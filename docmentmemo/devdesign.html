【実装指示書】PFCα Webアプリケーション
1. 開発概要
これから、AIを活用したPFCバランス管理Webアプリケーション「PFCα」を開発します。このドキュメントは、開発を円滑に進めるための技術的な仕様と要件を定義するものです。

開発目標:

開発はローカルのSupabase環境で行い、データベースの設計とテストを迅速に行う。

完成したアプリケーションはVercelにデプロイして公開する。

AI機能の中核にはGrok APIを活用し、パーソナライズされた体験を提供する。

2. 技術スタック
フレームワーク: React (Next.jsを強く推奨)。理由: Next.jsはサーバーサイドレンダリング(SSR)をサポートし、初期表示速度の向上に貢献します。また、APIルート機能を使えば、Grok APIとの連携ロジックをサーバーサイドに隠蔽でき、セキュリティと管理性が向上します。

言語: TypeScript

バックエンド/DB: Supabase (開発はローカルCLI、本番はクラウド)

スタイリング: Tailwind CSS

デプロイ先: Vercel

AI: Grok (VisionおよびLanguage Model)

3. 実装する画面と機能の詳細
画面1: ログインページ
目的: ユーザー認証を行い、サービス利用を開始する。

UI:

「PFCα」のロゴとシンプルなキャッチコピーを配置。

「GitHubでログイン」ボタン。

メールアドレスとパスワード入力フィールド、および「メールアドレスでログイン/新規登録」ボタン。

機能:

Supabase Authを利用して、GitHub OAuthおよびメールアドレスでの認証を実装する。

新規登録ユーザーの場合、認証成功後に自動でオンボーディングフローへ遷移させる。

画面2: オンボーディング（初期ヒアリング）
目的: ユーザーの初期データを収集し、AIによるパーソナライズの基礎を築く。

UI:

ログイン後、初回のみ表示されるモーダルまたは専用ページ。

複数ステップのフォーム形式で、以下の情報を順番にヒアリングする。

基本情報: ハンドルネーム、性別、生年月日

身体情報: 身長(cm)、現在の体重(kg)

活動レベル: 5段階から選択（例:「1: 座り仕事が中心」など説明付き）

目標設定: 目標（ダイエット/筋肉増量/健康維持）、目標体重(kg)

機能:

入力された全情報をSupabaseのprofilesテーブルに保存する。

このデータは、ダッシュボードでの理想PFC計算や、Grokへのコンテキスト情報として利用される。完了後、AIが算出した1日の目標摂取カロリーとPFCバランスのサマリーをモーダルで表示し、『ダッシュボードへ進む』ボタンでメイン画面へ遷移させることで、体験がよりスムーズになります。

画面3: ダッシュボード
目的: ユーザーが日々のPFCバランスと進捗を一目で把握し、AIから最適なアドバイスを受け取る。

UI構成:

PFCバランスグラフ:

** grouped bar chart（グループ化された棒グラフ）** を採用。

今日の「実績」PFC摂取量（g）と、AIが算出した「理想」PFC摂取量（g）を並べて表示。P/F/Cは色分けする。

グラフ上部に「日別」「週別」「月別」の切り替えタブを配置し、期間に応じた平均データを表示する。

AIアドバイスカード:

Grokが生成したアドバイスを表示する専用エリア。

初期実装では、より具体的で達成可能な目標を提示します。例えば、『過去7日間のデータに基づき、最もタンパク質が不足していた曜日の食事内容を改善する具体的なメニューを提案する』、『最も活動量が少なかった曜日に実行可能な軽い運動を提案する』など、ルールベースの具体的なアドバイスから始めることを推奨します。

食事記録ボタン (FAB):

画面右下にフローティングアクションボタンを配置。クリックすると食事記録モーダルが開く。

画面4: 食事記録モーダル
目的: 簡単な操作で日々の食事内容と栄養素を記録する。

UI:

「カメラで解析」「テキストで入力」の選択ボタン。

機能（カメラで解析）:

ユーザーが食事の画像をアップロードする。

画像データをGrokのVision APIに送信し、栄養成分（PFC、カロリー）の分析を依頼する。

Grokが返した食品名と栄養素の数値をフォームに自動入力して表示する。

【重要：AI学習ループ】

もしAIの解析結果（食品名）が間違っていた場合、ユーザーは食品名フィールドを正しいもの（例:「豚の生姜焼き」）に上書きできる。

ユーザーが食品名を修正した場合、その新しいテキストを元に再度Grokへ栄養素の検索・分析を依頼し、数値フィールドを更新する。

最終的に、ユーザーは全ての数値フィールドを自由に編集できる。

「登録」ボタンでmealsテーブルに保存。ユーザーによる修正があった場合はその情報も記録する。

機能（テキストで入力）:

ユーザーが「鶏胸肉 200g」のようにテキスト入力し、その内容をGrokに送信して栄養素を解析させる。以降のフローはカメラ解析と同様。

画面5: プロフィール・設定ページ
目的: ユーザー情報の編集と、AIの精度向上のための追加情報を提供。

UI:

プロフィール編集: オンボーディングで入力した情報の編集フォーム。

食事の好みヒアリング:

「嫌いな食べ物」「アレルギーのある食材」などを登録できるタグ形式の入力フィールド。

この情報は、Grokが食事メニューを提案する際に除外条件として利用される。

ログアウト、アカウント削除ボタン。「アカウント削除」をタップすると、『本当にアカウントを削除しますか？全てのデータが完全に削除され、元に戻すことはできません』という確認モーダルを表示します。ユーザーがテキストフィールドに『削除』と入力することで、最終的な削除ボタンが有効になります。

4. ローカルDB設計と外部連携
ローカルSupabaseデータベース設計
開発中は、以下のテーブル構造をローカル環境で構築・テストする。加えて、全てのテーブルに対してRow Level Security (RLS) ポリシーを必ず有効化してください。基本ポリシーとして、『ユーザーは自分自身のデータのみを閲覧・編集できる』というルールを設定します。これは必須のセキュリティ要件です。

profiles

id: uuid (AuthユーザーIDへの外部キー)

username: text

gender: text

birth_date: date

height_cm: numeric

initial_weight_kg: numeric

target_weight_kg: numeric

activity_level: integer (1-5)

goal_type: text (例: 'diet', 'bulk-up', 'maintain')

food_preferences: jsonb (例: { "dislikes": ["トマト"], "allergies": ["えび"] })

meals

id: uuid

user_id: uuid

food_name: text

calories: numeric

protein: numeric

fat: numeric

carbs: numeric

is_corrected_by_user: boolean

created_at: timestampz

daily_summaries (必須):

id: uuid

user_id: uuid

date: date

total_calories: numeric

total_protein: numeric

... (グラフ表示のパフォーマンス向上のため、1日ごとの集計データを保存)

このテーブルはパフォーマンス向上のために必須です。mealsテーブルへの追加・更新をトリガーとするデータベース関数を実装し、このテーブルを自動で更新してください。これにより、データの一貫性を保ちつつ、手動運用の手間とミスをなくせます。

Grok API 連携
APIキー管理: APIキーは.env.localファイルで管理し、Vercelの環境変数に設定する。

プロンプト設計例:

Vision分析: 「この画像に写っている食事の、食品名、総カロリー、PFCグラム数をJSON形式で返してください。」

ダッシュボードアドバイス: 「以下のユーザープロファイルと目標に基づき、今日1日の食事と運動に関する具体的なアドバイスをJSON形式で生成してください。形式は { "meal_advice": "...", "exercise_advice": "..." } です。ユーザー情報: {ここにprofilesテーブルのデータをJSONで挿入}」

Vercel デプロイ
ローカルで開発・テストが完了したコードをGitHubリポジトリにpushする。

VercelとGitHubリポジトリを連携し、自動デプロイを設定する。

Vercelのプロジェクト設定で、本番用のSupabaseプロジェクトURL、anonキー、およびGrokのAPIキーを環境変数として設定する。ローカルで行ったデータベースの変更を本番環境に適用する際は、安全のため以下の手順を踏むこと。 1. supabase link --project-ref <本番プロジェクトID>でローカル環境と本番プロジェクトを紐付ける。 2. supabase migration upコマンドを使って、バージョン管理されているマイグレーションファイルのみを本番データベースに適用する。